name: AKS Terraform + CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:

  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    env:
      ARM_SUBSCRIPTION_ID: ${{ secrets.AKSTERRAFORM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AKSTERRAFORM_TENANT_ID }}
      ARM_CLIENT_ID: ${{ secrets.AKSTERRAFORM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AKSTERRAFORM_CLIENT_SECRET }}
      TF_VAR_db_password: ${{ secrets.AKSTERRAFORM_DB_PASSWORD }}
      TF_VAR_github_actions_client_id: ${{ secrets.AKSTERRAFORM_CLIENT_ID }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: terraform
        run: terraform plan

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      - name: Capture Terraform outputs
        working-directory: terraform
        id: tf_output
        run: |
          echo "ACR_LOGIN_SERVER=$(terraform output -raw acr_login_server)" >> $GITHUB_ENV
          echo "KEY_VAULT_URI=$(terraform output -raw key_vault_uri)" >> $GITHUB_ENV
          echo "AKS_NAME=$(terraform output -raw aks_name)" >> $GITHUB_ENV
          echo "RG_NAME=$(terraform output -raw rg_name)" >> $GITHUB_ENV

  fetch-secrets:
    name: Fetch Key Vault Secrets
    runs-on: ubuntu-latest
    needs: terraform
    env:
      AZURE_CLIENT_ID: ${{ secrets.AKSTERRAFORM_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AKSTERRAFORM_CLIENT_SECRET }}
      AZURE_TENANT_ID: ${{ secrets.AKSTERRAFORM_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AKSTERRAFORM_SUBSCRIPTION_ID }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AKSTERRAFORM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AKSTERRAFORM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AKSTERRAFORM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AKSTERRAFORM_TENANT_ID }}"
            }

      - name: Fetch secrets from Key Vault
        uses: Azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ secrets.AKSTERRAFORM_KEYVAULT_NAME }}
          secrets: db-password  # Add other secret names as needed

      - name: Set secrets as env variables
        run: |
          echo "DB_PASSWORD=${{ steps.get-keyvault-secrets.outputs.db-password }}" >> $GITHUB_ENV

  build-and-deploy:
    name: Build Docker & Deploy to AKS
    runs-on: ubuntu-latest
    needs: fetch-secrets
    env:
      ACR_USERNAME: ${{ secrets.AKSTERRAFORM_ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.AKSTERRAFORM_ACR_PASSWORD }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AKSTERRAFORM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AKSTERRAFORM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AKSTERRAFORM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AKSTERRAFORM_TENANT_ID }}"
            }

      - name: Get AKS credentials
        run: |
          az aks get-credentials --resource-group $RG_NAME --name $AKS_NAME --overwrite-existing

      - name: Docker login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.AKSTERRAFORM_ACR_USERNAME }}
          password: ${{ secrets.AKSTERRAFORM_ACR_PASSWORD }}

      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ env.ACR_LOGIN_SERVER }}/myapp:${{ github.sha }}
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          docker build -t $IMAGE_TAG .

      - name: Push Docker image
        run: |
          docker push $IMAGE_TAG

      - name: Update Kubernetes deployment with new image
        run: |
          sed -i "s|{{IMAGE}}|$IMAGE_TAG|g" k8s/deployment.yaml

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/
