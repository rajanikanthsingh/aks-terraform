name: AKS Terraform + CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:

  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    outputs:
      acr_login_server: ${{ steps.tf_output.outputs.acr_login_server }}
      key_vault_uri: ${{ steps.tf_output.outputs.key_vault_uri }}
      aks_name: ${{ steps.tf_output.outputs.aks_name }}
      rg_name: ${{ steps.tf_output.outputs.rg_name }}
    env:
      ARM_SUBSCRIPTION_ID: ${{ secrets.AKSTERRAFORM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AKSTERRAFORM_TENANT_ID }}
      ARM_CLIENT_ID: ${{ secrets.AKSTERRAFORM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AKSTERRAFORM_CLIENT_SECRET }}
      TF_VAR_db_password: ${{ secrets.AKSTERRAFORM_DB_PASSWORD }}
      TF_VAR_github_actions_client_id: ${{ secrets.AKSTERRAFORM_CLIENT_ID }}
      TF_VAR_node_size: standard_dc2s_v3
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0

      - name: Login to Azure
        run: |
          az login --service-principal -u ${{ secrets.AKSTERRAFORM_CLIENT_ID }} \
                           -p ${{ secrets.AKSTERRAFORM_CLIENT_SECRET }} \
                           --tenant ${{ secrets.AKSTERRAFORM_TENANT_ID }}

      - name: Delete partially created Resource Group (safe for rerun)
        run: |
          set -euo pipefail
          if az group show -n rg-aks-demo &>/dev/null; then
            echo "Deleting resource group rg-aks-demo..."
            az group delete -n rg-aks-demo --yes --no-wait
          else
            echo "Resource group 'rg-aks-demo' not found; skipping delete."
          fi

      - name: Clean orphan Key Vault access policy (idempotent)
        run: |
          set -euo pipefail
          # Only attempt cleanup if the Key Vault exists
          if az keyvault show --name kvaksdemo --resource-group rg-aks-demo &>/dev/null; then
            echo "Key Vault 'kvaksdemo' exists — attempting to remove access policy for this SP (if present)"
            OBJECT_ID=$(az ad sp show --id "${{ secrets.AKSTERRAFORM_CLIENT_ID }}" --query objectId -o tsv || echo "")
            if [ -n "$OBJECT_ID" ]; then
              echo "Removing access policy for object id: $OBJECT_ID"
              az keyvault delete-policy --name kvaksdemo --object-id "$OBJECT_ID" || echo "No existing policy or deletion failed (continuing)"
            else
              echo "Could not resolve service principal object id; skipping delete-policy."
            fi
          else
            echo "Key Vault 'kvaksdemo' not found in 'rg-aks-demo' — skipping access policy cleanup."
          fi

          # Also ensure no local stale state exists on the runner
          echo "Cleaning terraform working directory on runner..."
          rm -rf terraform/.terraform || true
          rm -f terraform/.terraform.lock.hcl || true
          rm -f terraform/terraform.tfstate terraform/terraform.tfstate.backup || true

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -reconfigure

      - name: Terraform Plan
        working-directory: terraform
        run: terraform plan
          run: |
            set -euo pipefail
            ACR_OUT=$(terraform output -raw acr_login_server)
            KV_OUT=$(terraform output -raw key_vault_uri)
            AKS_OUT=$(terraform output -raw aks_name)
            RG_OUT=$(terraform output -raw rg_name)

            # Use the GITHUB_OUTPUT heredoc format to safely write values
            echo "acr_login_server<<EOF" >> $GITHUB_OUTPUT
            printf '%s
      - name: Capture Terraform outputs
            echo "EOF" >> $GITHUB_OUTPUT

            echo "key_vault_uri<<EOF" >> $GITHUB_OUTPUT
            printf '%s
        working-directory: terraform
            echo "EOF" >> $GITHUB_OUTPUT

            echo "aks_name<<EOF" >> $GITHUB_OUTPUT
            printf '%s
        id: tf_output
            echo "EOF" >> $GITHUB_OUTPUT

            echo "rg_name<<EOF" >> $GITHUB_OUTPUT
            printf '%s
        run: |
            echo "EOF" >> $GITHUB_OUTPUT
          echo "acr_login_server=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT
          echo "key_vault_uri=$(terraform output -raw key_vault_uri)" >> $GITHUB_OUTPUT
          echo "aks_name=$(terraform output -raw aks_name)" >> $GITHUB_OUTPUT
          echo "rg_name=$(terraform output -raw rg_name)" >> $GITHUB_OUTPUT

  fetch-secrets:
    name: Fetch Key Vault Secrets
    runs-on: ubuntu-latest
    needs: terraform
    env:
      AZURE_CLIENT_ID: ${{ secrets.AKSTERRAFORM_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AKSTERRAFORM_CLIENT_SECRET }}
      AZURE_TENANT_ID: ${{ secrets.AKSTERRAFORM_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AKSTERRAFORM_SUBSCRIPTION_ID }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AKSTERRAFORM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AKSTERRAFORM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AKSTERRAFORM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AKSTERRAFORM_TENANT_ID }}"
            }

      - name: Fetch secrets from Key Vault
        uses: Azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ secrets.AKSTERRAFORM_KEYVAULT_NAME }}
          secrets: db-password  # Add other secret names as needed

      - name: Set secrets as env variables
        run: |
          echo "DB_PASSWORD=${{ steps.get-keyvault-secrets.outputs.db-password }}" >> $GITHUB_ENV

  build-and-deploy:
    name: Build Docker & Deploy to AKS
    runs-on: ubuntu-latest
    needs: fetch-secrets
    env:
      ACR_USERNAME: ${{ secrets.AKSTERRAFORM_ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.AKSTERRAFORM_ACR_PASSWORD }}
      AKS_NAME: ${{ needs.terraform.outputs.aks_name }}
      RG_NAME: ${{ needs.terraform.outputs.rg_name }}
      ACR_LOGIN_SERVER: ${{ needs.terraform.outputs.acr_login_server }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AKSTERRAFORM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AKSTERRAFORM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AKSTERRAFORM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AKSTERRAFORM_TENANT_ID }}"
            }

      - name: Get AKS credentials
        run: |
          az aks get-credentials --resource-group $RG_NAME --name $AKS_NAME --overwrite-existing

      - name: Docker login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: $ACR_LOGIN_SERVER
          username: $ACR_USERNAME
          password: $ACR_PASSWORD

      - name: Build Docker image
        run: |
          IMAGE_TAG=$ACR_LOGIN_SERVER/myapp:${{ github.sha }}
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          docker build -t $IMAGE_TAG .

      - name: Push Docker image
        run: docker push $IMAGE_TAG

      - name: Update Kubernetes deployment with new image
        run: sed -i "s|{{IMAGE}}|$IMAGE_TAG|g" k8s/deployment.yaml

      - name: Apply Kubernetes manifests
        run: kubectl apply -f k8s/
